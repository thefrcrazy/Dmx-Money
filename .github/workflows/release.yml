name: Release
on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "DmxMoney ${{ github.ref_name }}" \
            --notes "Voir le [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) pour les dÃ©tails." \
            --draft=false \
            --prerelease=false || echo "Release already exists"

  build-and-upload:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            arch: 'aarch64'
            os_name: 'darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            arch: 'x64'
            os_name: 'darwin'
          - platform: 'windows-latest'
            args: ''
            arch: 'x64'
            os_name: 'windows'
          - platform: 'ubuntu-22.04'
            args: ''
            arch: 'x64'
            os_name: 'linux'

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libjavascriptcoregtk-4.1-dev

      - name: Install Frontend dependencies
        run: bun install

      - name: Switch to Modern Mode
        run: |
          chmod +x ./switch-tailwind.sh
          ./switch-tailwind.sh modern
        shell: bash

      # Build sans release automatique
      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          includeUpdaterJson: false
          args: ${{ matrix.args }}

      # Gestion manuelle des assets et signature
      - name: Process and Upload Assets
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SIGNING_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          SIGNING_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          ARCH: ${{ matrix.arch }}
          OS_NAME: ${{ matrix.os_name }}
          VERSION: ${{ github.ref_name }} # e.g. v0.1.5
        run: |
          echo "ðŸ” Finding assets..."
          
          # Nettoyage version pour noms de fichiers (v0.1.5 -> 0.1.5)
          CLEAN_VERSION="${VERSION#v}"
          
          # Identifier le bundle de mise Ã  jour (.tar.gz ou .zip)
          # On exclut le dossier deps/ pour ne pas prendre des intermÃ©diaires
          UPDATE_BUNDLE=$(find src-tauri/target -type f \( -name "*.app.tar.gz" -o -name "*.nsis.zip" -o -name "*.msi.zip" -o -name "*.AppImage.tar.gz" \) ! -path "*/deps/*" | head -n 1)
          
          if [ -z "$UPDATE_BUNDLE" ]; then
            echo "âŒ No update bundle found!"
            exit 1
          fi
          echo "ðŸ“¦ Found update bundle: $UPDATE_BUNDLE"
          
          # Renommage pour unicitÃ© (surtout macOS)
          # Ex: DmxMoney_0.1.5_aarch64.app.tar.gz
          EXT="${UPDATE_BUNDLE#*.}"
          if [[ "$UPDATE_BUNDLE" == *.tar.gz ]]; then EXT="tar.gz"; fi
          # macOS .app.tar.gz specific handling
          if [[ "$UPDATE_BUNDLE" == *.app.tar.gz ]]; then EXT="app.tar.gz"; fi
          
          # Nom final dÃ©sirÃ©
          NEW_BUNDLE_NAME="DmxMoney_${CLEAN_VERSION}_${ARCH}_${OS_NAME}.${EXT}"
          # Pour Windows/Linux, le nom est peut-Ãªtre dÃ©jÃ  bon ou diffÃ©rent, mais on standardise ici pour Ã©viter les conflits
          # Sauf que l'updater s'attend Ã  ce que la signature corresponde au fichier.
          
          echo "ðŸ”„ Renaming to $NEW_BUNDLE_NAME"
          mv "$UPDATE_BUNDLE" "./$NEW_BUNDLE_NAME"
          
          # Signature
          echo "âœï¸ Signing $NEW_BUNDLE_NAME..."
          export TAURI_SIGNING_PRIVATE_KEY="$SIGNING_KEY"
          export TAURI_SIGNING_PRIVATE_KEY_PASSWORD="$SIGNING_KEY_PASSWORD"
          bun tauri signer sign "./$NEW_BUNDLE_NAME"
          
          SIG_FILE="./$NEW_BUNDLE_NAME.sig"
          if [ ! -f "$SIG_FILE" ]; then
             echo "âŒ Signature creation failed"
             exit 1
          fi
          
          # Upload Bundle + Signature
          echo "roz Uploading bundle and signature..."
          gh release upload "$VERSION" "./$NEW_BUNDLE_NAME" "$SIG_FILE" --clobber
          
          # Upload Installeurs (.dmg, .exe, .AppImage, .deb)
          # On cherche tout ce qui est pertinent dans le dossier bundle
          # macOS: .dmg
          # Windows: .msi, .exe
          # Linux: .AppImage, .deb
          
          echo "ðŸ” Searching for installers..."
          find src-tauri/target -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.msi" -o -name "*.AppImage" -o -name "*.deb" \) ! -path "*/deps/*" | while read -r INSTALLER; do
            echo "ðŸš€ Uploading installer: $INSTALLER"
            gh release upload "$VERSION" "$INSTALLER" --clobber
          done

  generate-updater-json:
    needs: build-and-upload
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Generate multi-platform latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.ref_name }}"
          CLEAN_VERSION="${VERSION#v}"
          PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/$REPO/releases/download/$VERSION"

          echo "ðŸ“¦ Fetching release assets for $VERSION..."
          ASSETS=$(gh release view "$VERSION" --repo "$REPO" --json assets -q '.assets[].name')

          PLATFORMS="{}"

          add_platform() {
            local platform_key="$1"
            local pattern="$2"

            # On cherche le fichier .sig correspondant au pattern
            # Le pattern doit matcher le nom du bundle (PAS la signature)
            ASSET_NAME=$(echo "$ASSETS" | grep -E "$pattern" | grep -v '\.sig$' | head -n 1)
            
            if [ -n "$ASSET_NAME" ]; then
              SIG_NAME="${ASSET_NAME}.sig"
              if echo "$ASSETS" | grep -qF "$SIG_NAME"; then
                echo "âœ… $platform_key : $ASSET_NAME"
                # Download signature content
                gh release download "$VERSION" --repo "$REPO" -p "$SIG_NAME" -D /tmp --clobber
                SIGNATURE=$(cat "/tmp/$SIG_NAME")
                
                PLATFORMS=$(echo "$PLATFORMS" | jq \
                  --arg key "$platform_key" \
                  --arg sig "$SIGNATURE" \
                  --arg url "$BASE_URL/$ASSET_NAME" \
                  '. + {($key): {"signature": $sig, "url": $url}}')
              else
                echo "âš ï¸ Missing signature for $ASSET_NAME"
              fi
            else
              echo "â„¹ï¸ No asset match for $platform_key with pattern $pattern"
            fi
          }

          # Patterns basÃ©s sur le renommage effectuÃ© dans build-and-upload
          # Nom format: DmxMoney_0.1.5_aarch64_darwin.app.tar.gz
          add_platform "darwin-aarch64" "DmxMoney_.*_aarch64_darwin\.app\.tar\.gz"
          add_platform "darwin-x86_64"  "DmxMoney_.*_x64_darwin\.app\.tar\.gz"
          add_platform "windows-x86_64" "DmxMoney_.*_x64_windows\.(msi|nsis)\.zip"
          add_platform "linux-x86_64"   "DmxMoney_.*_x64_linux\.AppImage\.tar\.gz"

          jq -n \
            --arg version "$CLEAN_VERSION" \
            --arg notes "Mise Ã  jour vers la version $CLEAN_VERSION" \
            --arg pub_date "$PUB_DATE" \
            --argjson platforms "$PLATFORMS" \
            '{version: $version, notes: $notes, pub_date: $pub_date, platforms: $platforms}' > latest.json

          echo "ðŸ“„ latest.json content:"
          cat latest.json

          echo "ðŸš€ Uploading latest.json..."
          gh release upload "$VERSION" latest.json --clobber
