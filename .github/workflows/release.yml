name: Release
on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "DmxMoney ${{ github.ref_name }}" \
            --notes "Voir le [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) pour les dÃ©tails." \
            --draft=true \
            --prerelease=false || echo "Release already exists"

  build-and-upload:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-14' # Apple Silicon (M1/M2/M3)
            args: '--target aarch64-apple-darwin'
            arch: 'aarch64'
            os_name: 'darwin'
          - platform: 'macos-latest' # Intel Mac
            args: '--target x86_64-apple-darwin'
            arch: 'x64'
            os_name: 'darwin'
          - platform: 'windows-latest'
            args: ''
            arch: 'x64'
            os_name: 'windows'
          - platform: 'ubuntu-22.04'
            args: ''
            arch: 'x64'
            os_name: 'linux'

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libjavascriptcoregtk-4.1-dev zip

      - name: Install Frontend dependencies
        run: bun install --frozen-lockfile

      - name: Switch Tailwind Mode
        run: |
          chmod +x ./switch-tailwind.sh
          if [ "${{ matrix.arch }}" == "x64" ] && [ "${{ matrix.os_name }}" == "darwin" ]; then
            ./switch-tailwind.sh legacy
          else
            ./switch-tailwind.sh modern
          fi
        shell: bash

      # Build sans release automatique mais avec les clÃ©s pour gÃ©nÃ©rer les bundles d'update
      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          includeUpdaterJson: false
          args: ${{ matrix.args }}

      # Gestion manuelle des assets et signature
      - name: Process and Upload Assets
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SIGNING_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          SIGNING_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          ARCH: ${{ matrix.arch }}
          OS_NAME: ${{ matrix.os_name }}
          VERSION: ${{ github.ref_name }} # e.g. v0.1.7
        run: |
          echo "ðŸ” Finding assets..."
          CLEAN_VERSION="${VERSION#v}"
          BUNDLE_DIR=$(find src-tauri/target -type d -name "bundle" | head -n 1)
          
          if [ -z "$BUNDLE_DIR" ]; then
            echo "âŒ Bundle directory not found"
            exit 1
          fi
          
          UPDATE_BUNDLE=$(find "$BUNDLE_DIR" -type f \( -name "*.app.tar.gz" -o -name "*.AppImage.tar.gz" -o -name "*.nsis.zip" -o -name "*.msi.zip" \) | head -n 1)
          
          if [ -z "$UPDATE_BUNDLE" ]; then
             UPDATE_BUNDLE=$(find "$BUNDLE_DIR" -type f \( -name "*.tar.gz" -o -name "*.zip" \) | head -n 1)
          fi

          if [ -z "$UPDATE_BUNDLE" ]; then
            INSTALLER=$(find "$BUNDLE_DIR" -type f \( -name "*.exe" -o -name "*.msi" -o -name "*.AppImage" -o -name "*.dmg" \) | head -n 1)
            INST_FILENAME=$(basename "$INSTALLER")
            if [[ "$OS_NAME" == "windows" ]]; then
                NEW_ZIP="${INSTALLER}.zip"
                powershell -Command "Compress-Archive -Path '$INSTALLER' -DestinationPath '$NEW_ZIP'"
                UPDATE_BUNDLE="$NEW_ZIP"
            else
                NEW_TAR="${INSTALLER}.tar.gz"
                tar -czf "$NEW_TAR" -C "$(dirname "$INSTALLER")" "$INST_FILENAME"
                UPDATE_BUNDLE="$NEW_TAR"
            fi
          fi

          FILENAME=$(basename "$UPDATE_BUNDLE")
          if [[ "$FILENAME" == *.app.tar.gz ]]; then EXT="app.tar.gz"
          elif [[ "$FILENAME" == *.AppImage.tar.gz ]]; then EXT="AppImage.tar.gz"
          elif [[ "$FILENAME" == *.nsis.zip ]]; then EXT="nsis.zip"
          elif [[ "$FILENAME" == *.msi.zip ]]; then EXT="msi.zip"
          elif [[ "$FILENAME" == *.tar.gz ]]; then EXT="tar.gz"
          elif [[ "$FILENAME" == *.zip ]]; then EXT="zip"
          else EXT="${FILENAME##*.}"
          fi
          
          NEW_BUNDLE_NAME="DmxMoney_${CLEAN_VERSION}_${ARCH}_${OS_NAME}.${EXT}"
          cp "$UPDATE_BUNDLE" "./$NEW_BUNDLE_NAME"
          
          export TAURI_SIGNING_PRIVATE_KEY="$SIGNING_KEY"
          export TAURI_SIGNING_PRIVATE_KEY_PASSWORD="$SIGNING_KEY_PASSWORD"
          bun tauri signer sign "./$NEW_BUNDLE_NAME"
          
          gh release upload "$VERSION" "./$NEW_BUNDLE_NAME" "./$NEW_BUNDLE_NAME.sig" --clobber
          
          find "$BUNDLE_DIR" -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.msi" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" \) ! -path "*/deps/*" | while read -r INSTALLER_PATH; do
            INST_NAME=$(basename "$INSTALLER_PATH")
            NEW_INST_NAME="${INST_NAME%.*}_${ARCH}_${OS_NAME}.${INST_NAME##*.}"
            cp "$INSTALLER_PATH" "./$NEW_INST_NAME"
            gh release upload "$VERSION" "./$NEW_INST_NAME" --clobber
          done

  generate-updater-json:
    needs: build-and-upload
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Generate latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.ref_name }}"
          CLEAN_VERSION="${VERSION#v}"
          PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/$REPO/releases/download/$VERSION"
          ASSETS=$(gh release view "$VERSION" --repo "$REPO" --json assets -q '.assets[].name')
          PLATFORMS="{}"

          add_platform() {
            local platform_key="$1"
            local pattern="$2"
            ASSET_NAME=$(echo "$ASSETS" | grep -iE "$pattern" | grep -v '\.sig$' | head -n 1)
            if [ -n "$ASSET_NAME" ]; then
              gh release download "$VERSION" --repo "$REPO" -p "${ASSET_NAME}.sig" -D /tmp --clobber
              SIGNATURE=$(cat "/tmp/${ASSET_NAME}.sig")
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg key "$platform_key" --arg sig "$SIGNATURE" --arg url "$BASE_URL/$ASSET_NAME" '. + {($key): {"signature": $sig, "url": $url}}')
            fi
          }

          add_platform "darwin-aarch64" "aarch64.*darwin.*app\.tar\.gz"
          add_platform "darwin-x86_64"  "x64.*darwin.*app\.tar\.gz"
          add_platform "windows-x86_64" "x64.*windows.*(msi|nsis)\.zip"
          add_platform "linux-x86_64"   "x64.*linux.*AppImage.*tar\.gz"

          jq -n --arg version "$CLEAN_VERSION" --arg notes "Mise Ã  jour $CLEAN_VERSION" --arg pub_date "$PUB_DATE" --argjson platforms "$PLATFORMS" '{version: $version, notes: $notes, pub_date: $pub_date, platforms: $platforms}' > latest.json
          gh release upload "$VERSION" latest.json --repo "$REPO" --clobber
          gh release edit "$VERSION" --draft=false --repo "$REPO"
